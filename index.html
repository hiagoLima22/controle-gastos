<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Gastos PWA</title>
  <meta name="description" content="Aplicativo para controle de gastos pessoais">
  
  <!-- Meta tags PWA -->
  <meta name="theme-color" content="#4CAF50">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" href="icons/icon-192.png" type="image/png">

  <style>
    :root {
      --primary: #4CAF50;
      --primary-dark: #388E3C;
      --secondary: #2196F3;
      --danger: #F44336;
      --danger-dark: #D32F2F;
      --warning: #FF9800;
      --text: #333;
      --background: #f5f5f5;
      --card-bg: #fff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
      padding-bottom: 60px;
    }

    header {
      background-color: var(--primary);
      color: white;
      text-align: center;
      padding: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .container {
      max-width: 600px;
      margin: 1rem auto;
      padding: 1rem;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    h1, h2, h3 {
      margin-bottom: 1rem;
      color: var(--primary);
    }

    input, select, button {
      width: 100%;
      padding: 0.8rem;
      margin: 0.5rem 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }

    button {
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .btn-primary {
      background-color: var(--primary);
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
    }

    .btn-secondary {
      background-color: var(--secondary);
    }

    .btn-danger {
      background-color: var(--danger);
    }

    .btn-danger:hover {
      background-color: var(--danger-dark);
    }

    .btn-warning {
      background-color: var(--warning);
    }

    .btn-warning:hover {
      opacity: 0.9;
    }

    .gasto-card {
      background-color: white;
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: transform 0.2s;
    }

    .gasto-card:hover {
      transform: translateY(-2px);
    }

    .categoria {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      color: white;
      margin-top: 0.3rem;
    }

    .Alimenta√ß√£o { background-color: #FF7043; }
    .Transporte { background-color: #42A5F5; }
    .Lazer { background-color: #AB47BC; }
    .ContasFixas { background-color: #66BB6A; }
    .Outros { background-color: #8D6E63; }

    .resumo {
      background-color: #E3F2FD;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .update-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--primary);
      color: white;
      padding: 1rem;
      text-align: center;
      display: none;
      z-index: 1000;
    }

    .update-banner button {
      width: auto;
      margin-left: 1rem;
    }

    .debug-info {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.5rem;
      padding: 0.5rem;
      background-color: #f9f9f9;
      border-radius: 4px;
      border-left: 4px solid var(--primary);
    }

    @media (max-width: 600px) {
      .container {
        padding: 0.5rem;
      }
      
      .card {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>üí∞ Controle de Gastos</h1>
</header>

<div class="container">
  <div class="card">
    <h2>Adicionar Gasto</h2>
    <input type="text" id="nome" placeholder="Descri√ß√£o do gasto" required>
    <input type="number" id="valor" placeholder="Valor (R$)" step="0.01" min="0" required>
    
    <select id="categoria" required>
      <option value="" disabled selected>Selecione uma categoria</option>
      <option value="Alimenta√ß√£o">Alimenta√ß√£o üçî</option>
      <option value="Transporte">Transporte üöå</option>
      <option value="Lazer">Lazer üéâ</option>
      <option value="Contas Fixas">Contas Fixas üè†</option>
      <option value="Outros">Outros üíº</option>
    </select>
    
    <select id="tipo" required>
      <option value="" disabled selected>Tipo de gasto</option>
      <option value="Fixo">Fixo</option>
      <option value="Vari√°vel">Vari√°vel</option>
    </select>
    
    <select id="mes" required>
      <option value="" disabled selected>Selecione o m√™s</option>
      <option value="Janeiro">Janeiro</option>
      <option value="Fevereiro">Fevereiro</option>
      <option value="Mar√ßo">Mar√ßo</option>
      <option value="Abril">Abril</option>
      <option value="Maio">Maio</option>
      <option value="Junho">Junho</option>
      <option value="Julho">Julho</option>
      <option value="Agosto">Agosto</option>
      <option value="Setembro">Setembro</option>
      <option value="Outubro">Outubro</option>
      <option value="Novembro">Novembro</option>
      <option value="Dezembro">Dezembro</option>
    </select>
    
    <button class="btn-primary" onclick="adicionarGasto()">‚ûï Adicionar Gasto</button>
    <div class="debug-info" id="debugInfo">Status: Aguardando a√ß√£o...</div>
  </div>

  <div class="card">
    <h2>Filtrar Gastos</h2>
    <select id="mesFiltro" onchange="atualizarLista()">
      <option value="Todos">Todos os meses</option>
      <option value="Janeiro">Janeiro</option>
      <option value="Fevereiro">Fevereiro</option>
      <option value="Mar√ßo">Mar√ßo</option>
      <option value="Abril">Abril</option>
      <option value="Maio">Maio</option>
      <option value="Junho">Junho</option>
      <option value="Julho">Julho</option>
      <option value="Agosto">Agosto</option>
      <option value="Setembro">Setembro</option>
      <option value="Outubro">Outubro</option>
      <option value="Novembro">Novembro</option>
      <option value="Dezembro">Dezembro</option>
    </select>
  </div>

  <div class="card">
    <h2>Resumo Financeiro</h2>
    <div class="resumo" id="resumo">
      <p>Selecione um m√™s para visualizar o resumo</p>
    </div>
  </div>

  <div class="card">
    <h2>Seus Gastos</h2>
    <div id="lista">
      <div class="loading">Carregando seus gastos...</div>
    </div>
  </div>

  <button class="btn-danger" onclick="limparDados()">üóëÔ∏è Limpar Todos os Dados</button>
  <button class="btn-warning" onclick="verificarConexao()" style="margin-top: 10px;">
    üîç Verificar Conex√£o com Firebase
  </button>
</div>

<div class="update-banner" id="updateBanner">
  Nova vers√£o dispon√≠vel!
  <button onclick="atualizarApp()">Atualizar Agora</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where } 
          from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  // Configura√ß√£o do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDYm97mMo_5LL1iHaIlqaPEkzl79TQBDmA",
    authDomain: "controle-gastos-9fab2.firebaseapp.com",
    projectId: "controle-gastos-9fab2",
    storageBucket: "controle-gastos-9fab2.appspot.com",
    messagingSenderId: "535575893848",
    appId: "1:535575893848:web:4612a02e2bfb4f4362b72d"
  };

  // Inicializa o Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const debugInfo = document.getElementById("debugInfo");

  // ========== FUN√á√ïES PRINCIPAIS ========== //

  // Fun√ß√£o para verificar conex√£o com Firebase
  window.verificarConexao = async function() {
    try {
      debugInfo.textContent = "Testando conex√£o com Firebase...";
      const testDoc = await addDoc(collection(db, "testes_conexao"), {
        teste: new Date().toISOString(),
        status: "conexao_ativa"
      });
      await deleteDoc(doc(db, "testes_conexao", testDoc.id));
      debugInfo.textContent = "‚úÖ Conex√£o com Firebase estabelecida com sucesso!";
      alert("Conex√£o com Firebase funcionando perfeitamente!");
    } catch (error) {
      debugInfo.innerHTML = `‚ùå Falha na conex√£o com Firebase:<br>${error.message}`;
      alert(`ERRO: N√£o foi poss√≠vel conectar ao Firebase\n\n${error.message}\n\nVerifique:\n1. Sua conex√£o com a internet\n2. As regras do Firestore`);
    }
  };

  // Fun√ß√£o para adicionar gasto
  async function adicionarGasto() {
    try {
      // Valida√ß√£o de conex√£o
      if (!navigator.onLine) {
        throw new Error("Voc√™ est√° offline. Conecte-se √† internet.");
      }

      // Captura dos valores
      const nome = document.getElementById("nome").value.trim();
      const valor = parseFloat(document.getElementById("valor").value);
      const categoria = document.getElementById("categoria").value;
      const tipo = document.getElementById("tipo").value;
      const mes = document.getElementById("mes").value;

      // Valida√ß√£o dos campos
      if (!nome) throw new Error("Descri√ß√£o do gasto √© obrigat√≥ria");
      if (isNaN(valor) || valor <= 0) throw new Error("Valor inv√°lido");
      if (!categoria) throw new Error("Selecione uma categoria");
      if (!tipo) throw new Error("Selecione um tipo");
      if (!mes) throw new Error("Selecione um m√™s");

      debugInfo.textContent = "Salvando gasto no Firebase...";
      
      // Adiciona ao Firestore
      const docRef = await addDoc(collection(db, "gastos"), {
        nome,
        valor,
        categoria,
        tipo,
        mes,
        timestamp: new Date()
      });

      // Feedback de sucesso
      debugInfo.innerHTML = `‚úÖ Gasto salvo com sucesso!<br>ID: ${docRef.id}`;
      alert(`Gasto de ${mes} adicionado com sucesso!`);

      // Limpa os campos
      document.getElementById("nome").value = "";
      document.getElementById("valor").value = "";
      document.getElementById("categoria").value = "";
      document.getElementById("tipo").value = "";
      
      // Atualiza a lista
      atualizarLista();

    } catch (error) {
      console.error("Erro ao adicionar gasto:", error);
      debugInfo.innerHTML = `‚ùå Erro ao salvar:<br>${error.message}`;
      alert(`ERRO: ${error.message}`);
    }
  }

  // Fun√ß√£o para atualizar a lista de gastos
  async function atualizarLista() {
    try {
      const lista = document.getElementById("lista");
      const mesSelecionado = document.getElementById("mesFiltro").value;
      
      lista.innerHTML = '<div class="loading">Carregando...</div>';
      debugInfo.textContent = `Buscando gastos para: ${mesSelecionado}...`;
      
      // Cria a query
      const q = mesSelecionado === "Todos" 
        ? query(collection(db, "gastos"))
        : query(collection(db, "gastos"), where("mes", "==", mesSelecionado));

      const querySnapshot = await getDocs(q);
      
      // Processa os resultados
      let html = "";
      let totalFixo = 0, totalVariavel = 0;
      
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const categoriaClass = data.categoria.replace(/\s+/g, '');
        
        html += `
          <div class="gasto-card">
            <div>
              <strong>${data.nome}</strong> - R$ ${data.valor.toFixed(2)}
              <div class="categoria ${categoriaClass}">${data.categoria}</div>
              <small>${data.tipo} ‚Ä¢ ${data.mes}</small>
            </div>
            <button class="btn-excluir" onclick="excluirGasto('${doc.id}')">Excluir</button>
          </div>`;
        
        data.tipo === "Fixo" ? totalFixo += data.valor : totalVariavel += data.valor;
      });

      // Atualiza a UI
      lista.innerHTML = html || '<div class="loading">Nenhum gasto encontrado</div>';
      document.getElementById("resumo").innerHTML = `
        <p><strong>Total Fixo:</strong> R$ ${totalFixo.toFixed(2)}</p>
        <p><strong>Total Vari√°vel:</strong> R$ ${totalVariavel.toFixed(2)}</p>
        <p><strong>Total Geral:</strong> R$ ${(totalFixo + totalVariavel).toFixed(2)}</p>`;
      
      debugInfo.textContent = `‚úÖ ${querySnapshot.size} gastos encontrados`;

    } catch (error) {
      console.error("Erro ao carregar gastos:", error);
      debugInfo.innerHTML = `‚ùå Falha ao carregar:<br>${error.message}`;
      document.getElementById("lista").innerHTML = '<div class="loading">Erro ao carregar dados</div>';
    }
  }

  // Fun√ß√£o para excluir um gasto
  window.excluirGasto = async function(id) {
    if (confirm("Tem certeza que deseja excluir este gasto permanentemente?")) {
      try {
        debugInfo.textContent = "Excluindo gasto...";
        await deleteDoc(doc(db, "gastos", id));
        debugInfo.textContent = "‚úÖ Gasto exclu√≠do com sucesso";
        atualizarLista();
      } catch (error) {
        console.error("Erro ao excluir:", error);
        debugInfo.innerHTML = `‚ùå Falha ao excluir:<br>${error.message}`;
      }
    }
  };

  // Fun√ß√£o para limpar todos os dados
  window.limparDados = async function() {
    if (confirm("‚ö†Ô∏è ATEN√á√ÉO! Isso apagar√° TODOS os gastos permanentemente. Continuar?")) {
      try {
        debugInfo.textContent = "Iniciando limpeza...";
        const snapshot = await getDocs(collection(db, "gastos"));
        const deletions = snapshot.docs.map(d => deleteDoc(doc(db, "gastos", d.id)));
        await Promise.all(deletions);
        debugInfo.textContent = "‚úÖ Todos os dados foram removidos";
        atualizarLista();
        alert("Base de dados limpa com sucesso!");
      } catch (error) {
        console.error("Erro ao limpar dados:", error);
        debugInfo.innerHTML = `‚ùå Falha na limpeza:<br>${error.message}`;
      }
    }
  };

  // ========== INICIALIZA√á√ÉO ========== //

  // Configura o m√™s atual como padr√£o
  function configurarMesAtual() {
    const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                  "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    const mesAtual = meses[new Date().getMonth()];
    document.getElementById("mes").value = mesAtual;
    document.getElementById("mesFiltro").value = mesAtual;
  }

  // Registra Service Worker
  function registrarServiceWorker() {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => {
          console.log('Service Worker registrado:', reg.scope);
          
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                document.getElementById('updateBanner').style.display = 'block';
              }
            });
          });
        })
        .catch(err => console.log('Falha no Service Worker:', err));
    }
  }

  // Atualiza o app quando novo Service Worker estiver pronto
  window.atualizarApp = function() {
    if (navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({action: 'skipWaiting'});
    }
    window.location.reload();
  };

  // Inicializa√ß√£o ao carregar a p√°gina
  document.addEventListener("DOMContentLoaded", () => {
    configurarMesAtual();
    registrarServiceWorker();
    atualizarLista();
  });

  // Ouvinte para atualiza√ß√£o do Service Worker
  navigator.serviceWorker?.addEventListener('controllerchange', () => {
    window.location.reload();
  });
</script>
</body>
</html>
