<!DOCTYPE html>
<html lang="pt-br">
<head>
  <!-- [Previous head content remains exactly the same until the script tag] -->
</head>
<body>
<!-- [Previous body content remains exactly the same until the script tag] -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where } 
          from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDYm97mMo_5LL1iHaIlqaPEkzl79TQBDmA",
    authDomain: "controle-gastos-9fab2.firebaseapp.com",
    projectId: "controle-gastos-9fab2",
    storageBucket: "controle-gastos-9fab2.appspot.com",
    messagingSenderId: "535575893848",
    appId: "1:535575893848:web:4612a02e2bfb4f4362b72d"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const debugInfo = document.getElementById("debugInfo");

  // Test Firestore connection
  async function testConnection() {
    try {
      const testDoc = await addDoc(collection(db, "connection_test"), {
        test: "Testing Firestore connection",
        timestamp: new Date()
      });
      await deleteDoc(doc(db, "connection_test", testDoc.id));
      return true;
    } catch (error) {
      console.error("Connection test failed:", error);
      return false;
    }
  }

  // Add expense function
  window.adicionarGasto = async function() {
    if (!await testConnection()) {
      alert("Erro de conexão com o Firebase. Verifique sua internet e tente novamente.");
      return;
    }

    const nome = document.getElementById("nome").value.trim();
    const valor = parseFloat(document.getElementById("valor").value);
    const categoria = document.getElementById("categoria").value;
    const tipo = document.getElementById("tipo").value;
    const mes = document.getElementById("mes").value;

    if (!nome || isNaN(valor) || !categoria || !tipo || !mes) {
      alert("Preencha todos os campos corretamente!");
      return;
    }

    try {
      const docRef = await addDoc(collection(db, "gastos"), {
        nome,
        valor,
        categoria,
        tipo,
        mes,
        timestamp: new Date()
      });
      
      alert(`Gasto adicionado com sucesso em ${mes}!`);
      document.getElementById("nome").value = "";
      document.getElementById("valor").value = "";
      atualizarLista();
    } catch (error) {
      console.error("Error adding document: ", error);
      alert("Erro ao adicionar gasto: " + error.message);
    }
  };

  // Update expenses list
  window.atualizarLista = async function() {
    try {
      const mesSelecionado = document.getElementById("mesFiltro").value;
      const q = mesSelecionado === "Todos" 
        ? query(collection(db, "gastos"))
        : query(collection(db, "gastos"), where("mes", "==", mesSelecionado));

      const querySnapshot = await getDocs(q);
      let html = "";
      let totalFixo = 0, totalVariavel = 0;

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const categoriaClass = data.categoria.replace(/\s+/g, '');
        
        html += `
          <div class="gasto-card">
            <div>
              <strong>${data.nome}</strong> - R$ ${data.valor.toFixed(2)}
              <div class="categoria ${categoriaClass}">${data.categoria}</div>
              <small>${data.tipo} • ${data.mes}</small>
            </div>
            <button class="btn-excluir" onclick="excluirGasto('${doc.id}')">Excluir</button>
          </div>`;
        
        data.tipo === "Fixo" ? totalFixo += data.valor : totalVariavel += data.valor;
      });

      document.getElementById("lista").innerHTML = html || '<div class="loading">Nenhum gasto encontrado</div>';
      document.getElementById("resumo").innerHTML = `
        <p><strong>Total Fixo:</strong> R$ ${totalFixo.toFixed(2)}</p>
        <p><strong>Total Variável:</strong> R$ ${totalVariavel.toFixed(2)}</p>
        <p><strong>Total Geral:</strong> R$ ${(totalFixo + totalVariavel).toFixed(2)}</p>`;
    } catch (error) {
      console.error("Error getting documents: ", error);
    }
  };

  // Delete expense
  window.excluirGasto = async function(id) {
    if (confirm("Tem certeza que deseja excluir este gasto?")) {
      try {
        await deleteDoc(doc(db, "gastos", id));
        atualizarLista();
      } catch (error) {
        console.error("Error removing document: ", error);
      }
    }
  };

  // Clear all data
  window.limparDados = async function() {
    if (confirm("⚠️ ATENÇÃO! Isso apagará TODOS os gastos permanentemente. Continuar?")) {
      try {
        const snapshot = await getDocs(collection(db, "gastos"));
        const deletions = snapshot.docs.map(d => deleteDoc(doc(db, "gastos", d.id)));
        await Promise.all(deletions);
        atualizarLista();
        alert("Todos os dados foram removidos!");
      } catch (error) {
        console.error("Error clearing data: ", error);
      }
    }
  };

  // Initialize
  document.addEventListener("DOMContentLoaded", () => {
    const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", 
                  "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    const mesAtual = meses[new Date().getMonth()];
    document.getElementById("mes").value = mesAtual;
    document.getElementById("mesFiltro").value = mesAtual;
    atualizarLista();
  });

  // Service Worker registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(registration => {
          console.log('SW registered: ', registration.scope);
        })
        .catch(error => {
          console.log('SW registration failed: ', error);
        });
    });
  }
</script>
</body>
</html>
